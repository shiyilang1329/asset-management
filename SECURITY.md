# 安全功能说明

## 登录安全

### 1. 登录频率限制

系统已实现登录频率限制功能，防止暴力破解和恶意登录攻击。

#### 限制规则
- **最大失败次数**: 5次
- **锁定时间**: 15分钟
- **缓存过期**: 30分钟（失败记录自动清除）

#### 工作原理
1. 用户登录失败时，系统记录失败次数
2. 连续失败5次后，账号自动锁定15分钟
3. 锁定期间无法登录，提示剩余锁定时间
4. 登录成功后，自动清除失败记录
5. 15分钟后自动解锁

#### 用户体验
- 登录失败时显示剩余尝试次数
- 账号锁定时显示剩余锁定时间
- 友好的错误提示信息

### 2. 技术实现

#### 使用Caffeine缓存
```java
// 失败次数缓存（30分钟过期）
Cache<String, AtomicInteger> attemptsCache

// 锁定缓存（15分钟过期）
Cache<String, Long> lockCache
```

#### 优势
- **高性能**: 内存缓存，响应速度快
- **自动过期**: 无需手动清理
- **线程安全**: 支持并发访问
- **无依赖**: 不需要Redis等外部服务

### 3. 管理员功能

#### 解锁账号

管理员可以通过以下三种方式解锁被锁定的账号：

**方式1：在用户管理页面解锁（推荐）**
1. 登录系统
2. 进入"系统管理" → "用户管理"
3. 找到需要解锁的用户
4. 点击操作列的"解锁"按钮
5. 确认解锁

**方式2：通过API接口解锁**
```bash
POST /api/auth/unlock/{username}
```

示例：
```bash
curl -X POST http://localhost:8080/api/auth/unlock/admin \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**方式3：等待自动解锁**
- 锁定时间到期后（15分钟）自动解锁
- 无需人工干预

#### 检查账号状态
```bash
GET /api/auth/check/{username}
```

查看账号的锁定状态和剩余尝试次数。

### 4. 配置说明

可以在`LoginAttemptService.java`中修改配置：

```java
// 最大失败次数
private static final int MAX_ATTEMPTS = 5;

// 锁定时间（分钟）
private static final int LOCK_TIME_MINUTES = 15;
```

### 5. 日志记录

系统会记录以下安全事件：
- 登录失败（包含用户名）
- 账号锁定（包含用户名和剩余时间）
- 密码不匹配
- 账号被禁用

查看日志：
```bash
tail -f backend/logs/asset-management.log | grep "登录"
```

## 密码安全

### 1. 密码加密
- 使用BCrypt算法加密存储
- 每次加密结果不同（自动加盐）
- 无法反向解密

### 2. 密码策略
建议设置以下密码策略：
- 最小长度：6位
- 包含字母和数字
- 定期更换密码

### 3. 密码修改
用户可以通过以下方式修改密码：
1. 登录后在个人中心修改
2. 管理员可以重置用户密码

## JWT令牌安全

### 1. 令牌配置
- 有效期：24小时
- 签名算法：HS256
- 密钥：可通过环境变量配置

### 2. 令牌验证
- 每次请求验证令牌有效性
- 令牌过期自动跳转登录页
- 支持令牌刷新机制

## 权限控制

### 1. 基于角色的访问控制（RBAC）
- 用户 → 角色 → 权限
- 细粒度权限控制
- 菜单级和按钮级权限

### 2. 接口权限
- Spring Security保护
- JWT令牌验证
- 权限注解控制

## 安全建议

### 1. 生产环境
- [ ] 修改默认JWT密钥
- [ ] 启用HTTPS
- [ ] 配置防火墙规则
- [ ] 定期备份数据库
- [ ] 监控异常登录

### 2. 密码管理
- [ ] 强制使用强密码
- [ ] 定期更换密码
- [ ] 禁止使用常见密码
- [ ] 密码不能与用户名相同

### 3. 账号管理
- [ ] 及时禁用离职员工账号
- [ ] 定期审查用户权限
- [ ] 限制管理员账号数量
- [ ] 记录重要操作日志

### 4. 网络安全
- [ ] 限制IP访问（可选）
- [ ] 配置CORS策略
- [ ] 防止SQL注入
- [ ] 防止XSS攻击

## 常见问题

### Q1: 账号被锁定怎么办？
A: 有三种方式解锁：
1. 等待15分钟自动解锁
2. 联系管理员在"用户管理"页面点击"解锁"按钮
3. 管理员通过API接口手动解锁

### Q2: 如何查看登录失败记录？
A: 查看后端日志文件，搜索"登录失败"关键词。

### Q3: 可以修改锁定时间吗？
A: 可以，修改`LoginAttemptService.java`中的`LOCK_TIME_MINUTES`常量。

### Q4: 重启服务后锁定记录会丢失吗？
A: 会的，因为使用内存缓存。如需持久化，可以改用数据库存储。

### Q5: 如何防止分布式环境下的问题？
A: 当前实现适用于单机部署。如需分布式部署，建议使用Redis等分布式缓存。

## 更新日志

### 2026-01-15
- ✅ 添加登录频率限制功能
- ✅ 使用Caffeine内存缓存
- ✅ 添加管理员解锁接口
- ✅ 添加账号状态检查接口
- ✅ 优化错误提示信息
- ✅ 添加图形验证码功能
- ✅ 实现验证码自动刷新
- ✅ 验证码响应式设计

## 图形验证码

### 1. 验证码功能

系统已实现图形验证码功能，进一步增强登录安全性。

#### 功能特性
- **验证码类型**: 4位数字验证码
- **有效期**: 5分钟
- **一次性使用**: 验证后立即失效
- **自动刷新**: 登录失败后自动刷新
- **点击刷新**: 点击验证码图片可手动刷新

#### 验证码特性
- 图片尺寸：120x40像素
- 字体：Arial Bold 28号
- 干扰线：5条随机颜色线条
- 干扰点：50个随机分布点
- 字符颜色：随机深色（防OCR识别）
- 背景颜色：浅灰色

### 2. API接口

#### 获取验证码
```bash
GET /api/auth/captcha
```

响应：
```json
{
  "code": 200,
  "data": {
    "captchaId": "uuid",
    "captchaImage": "data:image/png;base64,..."
  }
}
```

#### 登录验证
```bash
POST /api/auth/login
```

请求参数：
```json
{
  "username": "admin",
  "password": "password",
  "captchaId": "uuid",
  "captchaCode": "1234"
}
```

### 3. 前端集成

#### 登录页面
- 页面加载时自动获取验证码
- 验证码输入框限制4位数字
- 点击验证码图片可刷新
- 登录失败后自动刷新验证码

#### 响应式设计
- **桌面端**: 验证码显示在输入框右侧
- **移动端**: 验证码显示在输入框下方，全宽显示

### 4. 安全性

- **防暴力破解**: 结合登录频率限制，双重保护
- **防OCR识别**: 随机颜色、干扰线、干扰点
- **防重放攻击**: 验证码一次性使用
- **防缓存攻击**: 5分钟自动过期
- **大小写不敏感**: 提升用户体验

### 5. 配置说明

可以在`CaptchaService.java`中修改配置：

```java
// 图片尺寸
private static final int WIDTH = 120;
private static final int HEIGHT = 40;

// 验证码长度
private static final int CODE_LENGTH = 4;

// 字符集（可改为字母+数字）
private static final String CODE_CHARS = "0123456789";

// 缓存配置
.expireAfterWrite(Duration.ofMinutes(5))  // 5分钟过期
.maximumSize(10000)                        // 最大缓存数量
```

## 相关文件

- `LoginAttemptService.java` - 登录限流服务
- `CaptchaService.java` - 验证码生成服务
- `AuthService.java` - 认证服务
- `AuthController.java` - 认证控制器
- `SecurityConfig.java` - 安全配置
- `JwtUtil.java` - JWT工具类
- `LoginDTO.java` - 登录请求DTO
- `frontend/src/views/login/index.vue` - 登录页面
- `frontend/src/api/auth.ts` - 认证API
